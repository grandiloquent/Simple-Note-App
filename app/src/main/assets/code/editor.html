<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑器</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify.min.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-css.min.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-html.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <script src="../animate/custom-toast.js"></script>
    <script src="../animate/shared.js"></script>
    <script src="../animate/editor.js"></script>
    <script src="../animate/glslx.js"></script>
    <script src="../animate/custom-dialog.js"></script>
</head>

<body data-mode="1">
    <div class="wrapper" style="padding: 49px 0 49px 0;">
        <textarea id="textarea" style="font-size: 14px"></textarea>
    </div>
    <div class="bar-renderer top" style="top: 0;">
    </div>
    <div class="bar-renderer bottom">





        <div id="comment_word" class="bar-item-tab" style="display: none;">
            <span class="material-symbols-outlined">
                comment
            </span>
            <div class="pivot-bar-item-title">注字</div>
        </div>
    </div>

    <style>
        .items {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: scroll;
        }

        .items::-webkit-scrollbar {
            display: none;
        }

        .items-wrapper {
            display: flex;
            width: 48px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            row-gap: 8px;
        }

        .item {
            flex: 0 0 0%;
            height: 48px;
            width: 100%;
            display: flex;
            align-items: center;
            flex-direction: column;
            user-select: none;
        }

        .title {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            max-height: 2.5em;
            -webkit-line-clamp: 1;
            overflow: hidden;
            line-height: 1.25;
            text-overflow: ellipsis;
            font-weight: normal
        }
    </style>
    <div class="items">

        <div class="items-wrapper" style="display: none;">
            <div class="item" id="text_snippet">
                <span class="material-symbols-outlined">
                    text_snippet
                </span>
                <div class="pivot-bar-item-title">代码段</div>
            </div>


            <div class="item" id="javascript">
                <span class="material-symbols-outlined">
                    javascript
                </span>
                <div class="pivot-bar-item-title">语句</div>
            </div>


            <div class="item" id="content_cut">
                <span class="material-symbols-outlined">
                    content_cut
                </span>
                <div class="pivot-bar-item-title">剪式</div>
            </div>


            <div class="item" id="function">
                <span class="material-symbols-outlined">
                    function
                </span>
                <div class="pivot-bar-item-title">函数</div>
            </div>



            <div class="item" id="navigate_next">
                <span class="material-symbols-outlined">
                    navigate_next
                </span>
                <div class="pivot-bar-item-title">前进</div>
            </div>

            <div class="item" id="variables_find_replace">
                <span class="material-symbols-outlined">
                    variables
                </span>
                <div class="pivot-bar-item-title">变量</div>
            </div>
            <div id="close-line" class="item">
                <span class="material-symbols-outlined">
                    close
                </span>
                <div class="pivot-bar-item-title">空行</div>
            </div>



        </div>
        <div class="items-wrapper selected">
        </div>
    </div>
    <custom-toast id="toast"></custom-toast>
    <script>
        let baseUri = window.location.host === "127.0.0.1:5500" ? "http://192.168.8.55:8500" : "..";
        const id = new URL(window.location).searchParams.get('id');

        const textarea = document.getElementById("textarea");
        findNextLineStart();

        async function loadData() {
            const res = await fetch(`${baseUri}/code?id=${id}`, {
                cache: "no-store"
            });
            if (res.status !== 200)
                throw new Error(res.status);
            return await res.json();


        }
        async function saveData() {
            let s = textarea.value.trim();
            if (!s) return;
            let body = {
                title: substringBefore(s, "\n").trim(),
                content: substringAfter(s, "\n").trim()
            };
            if (id) {
                body.id = parseInt(id, 10)
            }
            // await submitNote(getBaseUri(), JSON.stringify(body));
            // document.getElementById('toast').setAttribute('message', '成功');
            let res;
            try {
                res = await fetch(`${baseUri}/code`, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    cache: "no-store"
                });
                if (res.status !== 200) {
                    throw new Error();
                }
                if (!id) {
                    location.href = `/code/editor.html?id=${await res.text()}`;
                    return;
                }
                toast.setAttribute('message', '成功');
            } catch (error) {
                toast.setAttribute('message', '错误');
            }
        }
        async function saveDataWith(title) {
            let s = textarea.value.trim();
            if (!s) return;
            let body = {
                title,
                content: substringAfter(s, "\n").trim()
            };
            if (id) {
                body.id = parseInt(id, 10)
            }
            // await submitNote(getBaseUri(), JSON.stringify(body));
            // document.getElementById('toast').setAttribute('message', '成功');
            let res;
            try {
                res = await fetch(`${baseUri}/code`, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    cache: "no-store"
                });
                if (res.status !== 200) {
                    throw new Error();
                }
                if (!id) {
                    location.href = `/code/editor.html?id=${await res.text()}`;
                    return;
                }
                toast.setAttribute('message', '成功');
            } catch (error) {
                toast.setAttribute('message', '错误');
            }
        }
        async function cacheCode() {
            try {
                const data = await loadData();
                let content = data["content"];
                if (content.startsWith('"') && content.endsWith('"')) {
                    content = JSON.parse(content)
                }
                document.title = data["title"];
                textarea.value = `${data["title"]}
    
${content}`;
            } catch (error) {
                //textarea.value = localStorage.getItem('code.editor');
            }

        }
        function formatCode() {
            textarea.value = formatGlslCode(textarea.value);
        }
        function mode1() {
            mode10();
            mode11();
        }
        function mode2() {
            mode12()
            mode13()
        }
        function mode10() {
            const bottomBar = document.querySelector('.bar-renderer.top');
            bottomBar.innerHTML = '';
            [
                [
                    "preview",
                    "预览",
                    async () => {

                        await preview();
                    }
                ],
                [
                    "content_copy",
                    "复字",
                    () => {
                        copyWord(textarea)
                    }
                ],
                [
                    "content_copy",
                    "粘字",
                    () => {
                        pasteWord(textarea)
                    }
                ],
                [
                    "content_copy",
                    "复行",
                    () => {
                        copyLine(textarea)
                    }
                ],
                [
                    "close",
                    "剪行",
                    () => {

                        deleteLine(textarea)
                    }
                ],
                [
                    "close",
                    "剪块",
                    () => {
                        deleteBlock(textarea)
                    }
                ],
                [
                    "content_copy",
                    "复行",
                    () => {
                        copyLine(textarea)
                    }
                ],
                [
                    "comment",
                    "注释",
                    () => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let s = `
// ============================
// 
// ============================
`;
                        textarea.setRangeText(s, selectionStart, selectionEnd)


                    }
                ],

            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "bar-item-tab";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function mode11() {
            const bottomBar = document.querySelector('.bar-renderer.bottom');
            bottomBar.innerHTML = '';
            [
                [
                    "comment",
                    "注释",
                    () => {
                        commentLine(textarea)
                    }
                ],

                [
                    "density_large",
                    "正常",
                    () => {
                        duplicateLine(textarea);
                    }
                ],
                [
                    "density_large",
                    "截断",
                    () => {
                        breakLine1(textarea);
                    }
                ],
                [
                    "density_large",
                    "截断",
                    () => {
                        breakLine2(textarea);
                    }
                ],
                [
                    "content_copy",
                    "复块",
                    () => {
                        copyBlock(textarea)
                    }
                ],

                [
                    "function",
                    "展数",
                    () => {
                        functionsExpand(textarea);
                    }
                ], [
                    "variables",
                    "收变",
                    () => {

                        variables(textarea);
                    }
                ], [
                    "data_object",
                    "展变",
                    () => {

                        parentheses(textarea);
                    }
                ],


            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "bar-item-tab";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function mode12() {
            const bottomBar = document.querySelector('.bar-renderer.top');
            bottomBar.innerHTML = '';
            [
                [
                    "preview",
                    "预览",
                    async () => {

                        await preview();
                    }
                ],
                [
                    "close",
                    "剪行",
                    () => {

                        deleteLine(textarea)
                    }
                ],
                [
                    "close",
                    "剪块",
                    () => {
                        deleteBlock(textarea)
                    }
                ],
                [
                    "code",
                    "格式",
                    () => {
                        formatCode();
                    }
                ],
                [
                    "decimal_decrease",
                    "简化",
                    () => {
                        decreaseCode(textarea)
                        formatCode();
                    }
                ],

                [
                    "content_copy",
                    "复行",
                    () => {
                        copyLine(textarea)
                    }
                ],
                [
                    "comment",
                    "注释",
                    () => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let s = `
// ============================
// 
// ============================
`;
                        textarea.setRangeText(s, selectionStart, selectionEnd)


                    }
                ],

            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "bar-item-tab";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function mode13() {
            const bottomBar = document.querySelector('.bar-renderer.bottom');
            bottomBar.innerHTML = '';
            [
                [
                    "save",
                    "保存",
                    async () => {
                        await saveData();

                    }
                ],
                [
                    "favorite",
                    "保存",
                    async () => {
                        await saveDataWith("WebGL 练习");

                    }
                ],
                [
                    "heart_minus",
                    "保存",
                    async () => {
                        await saveDataWith("有问题");

                    }
                ],
                [
                    "go_to_line",
                    "调试",
                    () => {
                        goToLine(textarea);
                    }
                ],
                [
                    "switch_right",
                    "交换",
                    () => {
                        switchStatement(textarea);
                    }
                ],
                [
                    "shuffle",
                    "随机",
                    async () => {
                        if (id) {
                            try {
                                const response = await fetch(`${baseUri}/code/random`);
                                if (response.status > 399 || response.status < 200) {
                                    throw new Error(`${response.status}: ${response.statusText}`)
                                }
                                const results = await response.text();
                                window.location.href = `?id=${results}`
                            } catch (error) {
                                console.log(error);
                            }
                        }
                        else
                            window.location.reload();
                    }
                ], [
                    "text_snippet",
                    "图片",
                    () => {
                        insertSnippet1();
                    }
                ],
                [
                    "text_snippet",
                    "颜色",
                    () => {
                        insertSnippet2();
                    }
                ],
            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "bar-item-tab";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function mode7() {
            const bottomBar = document.querySelector('.bar-renderer.bottom');
            bottomBar.innerHTML = '';
            [
                [
                    "comment",
                    "注释",
                    () => {
                        commentLine(textarea)
                    }
                ],

                [
                    "density_large",
                    "正常",
                    () => {
                        duplicateLine(textarea);
                    }
                ],
                [
                    "density_large",
                    "截断",
                    () => {
                        breakLine1(textarea);
                    }
                ],
                [
                    "density_large",
                    "截断",
                    () => {
                        breakLine2(textarea);
                    }
                ],
                [
                    "content_copy",
                    "复块",
                    () => {
                        copyBlock(textarea)
                    }
                ],

                [
                    "function",
                    "展数",
                    () => {
                        functionsExpand(textarea);
                    }
                ], [
                    "variables",
                    "收变",
                    () => {

                        variables(textarea);
                    }
                ], [
                    "data_object",
                    "展变",
                    () => {

                        parentheses(textarea);
                    }
                ],


            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "bar-item-tab";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function mode8() {
           
        }
        function mode3() {
            const bottomBar = document.querySelector('.bar-renderer.bottom');
            bottomBar.innerHTML = '';
            [
                [
                    "density_large",
                    "复行",
                    () => {
                        duplicateStart(textarea);
                    }
                ], [
                    "variables",
                    "收变",
                    () => {

                        variablesString(textarea);
                    }
                ],
                [
                    "function",
                    "smoothstep",
                    () => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let s = `smoothstep(0.0,x,y)`;
                        textarea.setRangeText(s, selectionStart, selectionEnd)
                    }
                ],
                [
                    "function",
                    "step",
                    () => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let s = `step(0.0,x,y)`;
                        textarea.setRangeText(s, selectionStart, selectionEnd)
                    }
                ],
                [
                    "function",
                    ".",
                    () => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let s = `fragColor.w = 1.0;
uv.y=1.0 - uv.y;
`;
                        textarea.setRangeText(s, selectionStart, selectionEnd)
                    }
                ],
                [
                    "function",
                    "float",
                    () => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let s = `
/*
float f = step(t,v);
float len = length(center - uv);
vec2 uv = (gl_FragCoord.xy) / iResolution.xy;
uv.y=1.0 - uv.y;
vec2 pointCenter = vec2(cos(iTime), sin(iTime));
vec3 color = backGroundColor * gridColor * circleLine * point * segement;
fragColor = vec4(color, 1.0); 
let s=sin(radians(90.)); 


mat2 rotate2d(float theta) {
  float s = sin(theta), c = cos(theta);
  return mat2(c, -s, s, c);
}

float sdSphere(vec3 p, float r, vec3 offset)
{
  return length(p - offset) - r;
}

float opUnion(float d1, float d2) { 
  return min(d1, d2);
}

float opSmoothUnion(float d1, float d2, float k) {
  float h = clamp( 0.5 + 0.5*(d2-d1)/k, 0.0, 1.0 );
  return mix( d2, d1, h ) - k*h*(1.0-h);
}

float opIntersection(float d1, float d2) {
  return max(d1, d2);
}

float opSmoothIntersection(float d1, float d2, float k) {
  float h = clamp( 0.5 - 0.5*(d2-d1)/k, 0.0, 1.0 );
  return mix( d2, d1, h ) + k*h*(1.0-h);
}

float opSubtraction(float d1, float d2) {
  return max(-d1, d2);
}

float opSmoothSubtraction(float d1, float d2, float k) {
  float h = clamp( 0.5 - 0.5*(d2+d1)/k, 0.0, 1.0 );
  return mix( d2, -d1, h ) + k*h*(1.0-h);
}

float opSubtraction2(float d1, float d2) {
  return max(d1, -d2);
}

float opSmoothSubtraction2(float d1, float d2, float k) {
  float h = clamp( 0.5 - 0.5*(d2+d1)/k, 0.0, 1.0 );
  return mix( d1, -d2, h ) + k*h*(1.0-h);
}

float opSymX(vec3 p, float r, vec3 o)
{
  p.x = abs(p.x);
  return sdSphere(p, r, o);
}

float opSymXZ(vec3 p, float r, vec3 o)
{
  p.xz = abs(p.xz);
  return sdSphere(p, r, o);
}

float opRep(vec3 p, float r, vec3 o, vec3 c)
{
  vec3 q = mod(p+0.5*c,c)-0.5*c;
  return sdSphere(q, r, o);
}

float opRepLim(vec3 p, float r, vec3 o, float c, vec3 l)
{
  vec3 q = p-c*clamp(round(p/c),-l,l);
  return sdSphere(q, r, o);
}

float opDisplace(vec3 p, float r, vec3 o)
{
  float d1 = sdSphere(p, r, o);
  float d2 = sin(p.x)*sin(p.y)*sin(p.z) * cos(iTime);
  return d1 + d2;
}

float scene(vec3 p) {
  float d1 = sdSphere(p, 1., vec3(0, -1, 0));
  float d2 = sdSphere(p, 0.75, vec3(0, 0.5, 0));
  //return d1;
  //return d2;
  //return opUnion(d1, d2);
  //return opSmoothUnion(d1, d2, 0.2);
  //return opIntersection(d1, d2);
  //return opSmoothIntersection(d1, d2, 0.2);
  //return opSubtraction(d1, d2);
  //return opSmoothSubtraction(d1, d2, 0.2);
  //return opSubtraction2(d1, d2);
  //return opSmoothSubtraction2(d1, d2, 0.2);
  //return opSymX(p, 1., vec3(1, 0, 0));
  //return opSymXZ(p, 1., vec3(1, 0, 1));
  //return opRep(p, 1., vec3(0), vec3(8));
  //return opRepLim(p, 0.5, vec3(0), 2., vec3(1, 0, 1));
  return opDisplace(p, 1., vec3(0));
}

float rayMarch(vec3 ro, vec3 rd) {
  float depth = MIN_DIST;
  float d; // distance ray has travelled

  for (int i = 0; i < MAX_MARCHING_STEPS; i++) {
    vec3 p = ro + depth * rd;
    d = scene(p);
    depth += d;
    if (d < PRECISION || depth > MAX_DIST) break;
  }
  
  d = depth;
  
  return d;
}

vec3 calcNormal(in vec3 p) {
    vec2 e = vec2(1, -1) * EPSILON;
    return normalize(
      e.xyy * scene(p + e.xyy) +
      e.yyx * scene(p + e.yyx) +
      e.yxy * scene(p + e.yxy) +
      e.xxx * scene(p + e.xxx));
}

mat3 camera(vec3 cameraPos, vec3 lookAtPoint) {
	vec3 cd = normalize(lookAtPoint - cameraPos);
	vec3 cr = normalize(cross(vec3(0, 1, 0), cd));
	vec3 cu = normalize(cross(cd, cr));
	
	return mat3(-cr, cu, -cd);
}

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
  vec2 uv = (fragCoord-.5*iResolution.xy)/iResolution.y;
  vec2 mouseUV = iMouse.xy/iResolution.xy;
  
  if (mouseUV == vec2(0.0)) mouseUV = vec2(0.5); // trick to center mouse on page load

  vec3 col = vec3(0);
  vec3 lp = vec3(0);
  vec3 ro = vec3(0, 0, 3); // ray origin that represents camera position
  
  float cameraRadius = 2.;
  ro.yz = ro.yz * cameraRadius * rotate2d(mix(-PI/2., PI/2., mouseUV.y));
  ro.xz = ro.xz * rotate2d(mix(-PI, PI, mouseUV.x)) + vec2(lp.x, lp.z);

  vec3 rd = camera(ro, lp) * normalize(vec3(uv, -1)); // ray direction

  float d = rayMarch(ro, rd); // signed distance value to closest object

  if (d > MAX_DIST) {
    col = COLOR_BACKGROUND; // ray didn't hit anything
  } else {
    vec3 p = ro + rd * d; // point discovered from ray marching
    vec3 normal = calcNormal(p); // surface normal

    vec3 lightPosition = vec3(0, 2, 2);
    vec3 lightDirection = normalize(lightPosition - p) * .65; // The 0.65 is used to decrease the light intensity a bit

    float dif = clamp(dot(normal, lightDirection), 0., 1.) * 0.5 + 0.5; // diffuse reflection mapped to values between 0.5 and 1.0

    col = vec3(dif) + COLOR_AMBIENT;    
  }

  fragColor = vec4(col, 1.0);
}
*/   
                        `;
                        textarea.setRangeText(s, selectionStart, selectionEnd)
                    }
                ],
            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "bar-item-tab";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }

        function mode5() {
            const bottomBar = document.querySelector('.items-wrapper.selected');
            bottomBar.innerHTML = '';
            [
                [
                    "light_mode",
                    "模式",
                    () => {
                        let mode = parseInt(document.body.dataset.mode);
                        mode++;
                        if (mode > 2) {
                            mode = 1;
                        }
                        document.body.dataset.mode = mode;
                        localStorage.setItem('light_mode', mode);
                        setMode(mode);

                    }
                ],
                [
                    "text_snippet",
                    "代码",
                    async () => {

                        await saveData();
                        if (typeof NativeAndroid !== 'undefined') {
                            NativeAndroid.launchApp("psycho.euphoria.l", `/code/notes.html`);
                        } else {
                            window.open('notes.html', '_blank');
                        }
                    }
                ],


                [
                    "find_replace",
                    "替换",
                    () => {
                        findReplace(textarea);
                    }
                ],
                [
                    "comment",
                    "注释",
                    () => {
                        comment(textarea);
                    }
                ],

                [
                    "exposure_plus_2",
                    "放大",
                    () => {
                        decrease2(textarea, true);

                    }
                ],
                [
                    "exposure_neg_2",
                    "缩小",
                    () => {
                        decrease2(textarea);

                    }
                ],
            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "item";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    evt.stopPropagation();
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function mode6() {
            const bottomBar = document.querySelector('.items-wrapper');
            bottomBar.innerHTML = '';
            [
                [
                    "light_mode",
                    "模式",
                    () => {
                        let mode = parseInt(document.body.dataset.mode);
                        mode++;
                        if (mode > 2) {
                            mode = 1;
                        }
                        document.body.dataset.mode = mode;
                        localStorage.setItem('light_mode', mode);
                        setMode(mode);

                    }
                ],
                [
                    "text_snippet",
                    "代码",
                    async () => {

                        await saveData();
                        if (typeof NativeAndroid !== 'undefined') {
                            NativeAndroid.launchApp("psycho.euphoria.l", `/code/notes.html`);
                        } else {
                            window.open('notes.html', '_blank');
                        }
                    }
                ],

                [
                    "translate",
                    "翻译",
                    () => {
                        translate(baseUri, textarea);

                    }
                ],
                [
                    "find_replace",
                    "替换",
                    () => {
                        findReplace(textarea);
                    }
                ],
                [
                    "comment",
                    "注释",
                    () => {
                        comment(textarea);
                    }
                ],


                [
                    "save",
                    "保存",
                    async () => {
                        await saveData();

                    }
                ],
            ].forEach(x => {
                const div = document.createElement('div');
                div.className = "item";
                div.innerHTML = `<span class="material-symbols-outlined">${x[0]}</span>
            <div class="pivot-bar-item-title">${x[1]}</div>`;
                div.addEventListener('click', evt => {
                    evt.stopPropagation();
                    x[2]();
                });
                bottomBar.appendChild(div);
            })
        }
        function initialize() {
            mode5()
            const mode = parseInt(localStorage.getItem('light_mode')) || 1;
            setMode(mode);

            document.getElementById('variables_find_replace').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();
                variablesReplace(textarea)
            })




            document.getElementById('content_cut').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();
                cutLine(textarea)
            })

            document.getElementById('javascript').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();


                let selectionStart = textarea.selectionStart;
                let selectionEnd = textarea.selectionEnd;
                let s = `if(x === undefined){
}
else if(x !== undefined){
}
else{
}`;
                textarea.setRangeText(s, selectionStart, selectionEnd)
            })




            document.getElementById('function').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();
                functions(textarea);
            })




            document.getElementById('text_snippet').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();

                showSnippetsDialog();
            })




            // document.getElementById('search').addEventListener('click', async evt => {
            //     evt.stopPropagation();
            //     evt.stopImmediatePropagation();
            //     const points = getWordString(textarea);
            //     let v = textarea.value.substring(points[0], points[1]).trim();
            //     const s = `https://www.google.com/search?q=` + encodeURIComponent(v);
            //     if (typeof NativeAndroid !== 'undefined') {
            //         NativeAndroid.launchApp("psycho.euphoria.l", s);
            //     } else {
            //         window.open(s, '_blank');
            //     }
            // });
            document.getElementById('close-line').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();
                //deleteLine(textarea)
                removeEmptyLinesBlock(textarea)
            });





            document.getElementById('navigate_next').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();
                if (id)
                    window.location.href = `?id=${parseInt(id) + 1}`
                else
                    window.location.reload();
            });



            document.querySelector('.items-wrapper.selected').addEventListener('click', evt => {
                evt.stopPropagation();
                evt.stopImmediatePropagation();
                const e = document.querySelector('.items-wrapper');
                if (e.hasAttribute('style')) {
                    e.removeAttribute('style');
                } else {
                    e.style.display = 'none';
                }
            });

            // document.getElementById('comment_word').addEventListener('click', evt => {
            //     commentWord(textarea)
            // })

            document.addEventListener('keydown', async evt => {
                if (evt.ctrlKey) {
                    if (evt.key === 's') {
                        evt.preventDefault();
                        await saveData();
                    }
                } else {
                    if (evt.key === 'F1') {
                        evt.preventDefault();
                        formatCode();
                    } else if (evt.key === 'F3') {
                        evt.preventDefault();
                        await preview();
                    } else if (evt.key === 'F4') {
                        evt.preventDefault();
                        if (id)
                            window.location.href = `?id=${parseInt(id) + 1}`
                        else
                            window.location.reload();
                    } else if (evt.key === 'F7') {
                        evt.preventDefault();
                        textarea.value = await readText();//glslTemplate(0);
                    } else if (evt.key === 'F5') {
                        evt.preventDefault();
                        await glslTemplate(1);
                    } else if (evt.key === 'F2') {
                        evt.preventDefault();
                        await glslTemplate(0);
                    } else if (evt.key === 'F6') {
                        evt.preventDefault();
                        textarea.value = textarea.value.replace(/(?<=iFrame;)[\n\r\s]+uniform vec3 iChannelResolution\[4\];()/, `
uniform vec3 iChannelResolution[4];            
${await readText()}`)

                    }
                    // uniform vec4      iMouse
                }

            })



        }

        function setMode(mode) {
            if (mode === 1) {
                mode1();
            }
            else if (mode === 2) {
                mode2();
            } else if (mode === 3) {
                mode3();
            }
        }
        async function preview() {
            try {
                await saveData();
                //localStorage.setItem('code.editor', textarea.value.trim());
            } catch (error) {

            }
            if (typeof NativeAndroid !== 'undefined') {
                NativeAndroid.launchApp("psycho.euphoria.l", `/viewer?id=${id}`);
            } else {
                window.open(`/viewer?id=${id}`, '_blank');
            }
        }
        cacheCode();
        initialize();

    </script>
</body>

</html>