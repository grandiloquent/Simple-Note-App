<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑器</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-html.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <script src="../animate/custom-toast.js"></script>
    <script src="../animate/shared.js"></script>
    <script src="../animate/glslx.js"></script>
    <script src="../animate/custom-dialog.js"></script>
</head>

<body>
    <div class="wrapper" style="padding: 0px 0 49px 0;">
        <textarea id="textarea" style="font-size: 14px"></textarea>
    </div>
    
    <div class="bar-renderer">

        <div class="bar-item-tab" id="text_snippet">
            <span class="material-symbols-outlined">
                text_snippet
            </span>
            <div class="pivot-bar-item-title">代码段</div>
        </div>
        <div class="bar-item-tab" id="variables">
            <span class="material-symbols-outlined">
                variables
            </span>
            <div class="pivot-bar-item-title">变量</div>
        </div>

        <div class="bar-item-tab" id="javascript">
            <span class="material-symbols-outlined">
                javascript
            </span>
            <div class="pivot-bar-item-title">语句</div>
        </div>
        <div class="bar-item-tab" id="find_replace">
            <span class="material-symbols-outlined">
                find_replace
            </span>
            <div class="pivot-bar-item-title">替换</div>
        </div>

    </div>
    <style>
        .items {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 48px;
            z-index: 100001;
            display: flex;
            flex-direction: column;
            align-items: center;
            row-gap: 8px;
            justify-content: center;
        }

        .item {
            flex: 0 0 0%;
            height: 48px;
            width: 100%;
            display: flex;
            align-items: center;
            flex-direction: column;
        }
    </style>
    <div class="items">
        <div class="item" id="comment">
            <span class="material-symbols-outlined">
                comment
            </span>
            <div class="pivot-bar-item-title">注释</div>
        </div>
        
        <div id="preview" class="item">
            <span class="material-symbols-outlined">
                preview
            </span>
            <div class="pivot-bar-item-title">预览</div>
        </div>
        <div id="save" class="item">
            <span class="material-symbols-outlined">
                save
            </span>
            <div class="pivot-bar-item-title">保存</div>
        </div>
        <div class="item" id="format">
            <span class="material-symbols-outlined">
                code
            </span>
            <div class="pivot-bar-item-title">格式化</div>
        </div>
        
        <div class="item" id="translate">
            <span class="material-symbols-outlined">
                translate
            </span>
            <div class="pivot-bar-item-title">翻译</div>
        </div>
        <div class="item" id="function">
            <span class="material-symbols-outlined">
                function
            </span>
            <div class="pivot-bar-item-title">函数</div>
        </div>
    </div>
    <custom-toast id="toast"></custom-toast>
    <script>
        let baseUri = window.location.host === "127.0.0.1:5500" ? "http://192.168.8.55:8500" : "..";
        const id = new URL(window.location).searchParams.get('id');

        const textarea = document.getElementById("textarea");
        async function loadData() {
            const res = await fetch(`${baseUri}/code?id=${id}`);
            if (res.status !== 200)
                throw new Error(res.status);
            return await res.json();


        }
        async function saveData() {
            let s = textarea.value.trim();
            if (!s) return;
            let body = {
                id: id ? parseInt(id, 10) : 0,
                title: substringBefore(s, "\n").trim(),
                content: substringAfter(s, "\n").trim()
            };
            // await submitNote(getBaseUri(), JSON.stringify(body));
            // document.getElementById('toast').setAttribute('message', '成功');
            let res;
            try {
                res = await fetch(`${baseUri}/code`, {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                if (res.status !== 200) {
                    throw new Error();
                }
                toast.setAttribute('message', '成功');
            } catch (error) {
                toast.setAttribute('message', '错误');
            }
        }
        async function cacheCode() {
            try {
                const data = await loadData();
                let content = data["content"];
                if (content.startsWith('"') && content.endsWith('"')) {
                    content = JSON.parse(content)
                }
                document.title = data["title"];
                textarea.value = `${data["title"]}
    
${content}`;
            } catch (error) {
                textarea.value = localStorage.getItem('code.editor');
            }

        }
        function formatCode() {
            textarea.value = formatGlslCode(textarea.value);
        }
        function initialize() {
            // document.addEventListener('visibilitychange', async evt => {
            //     if (document.visibilityState !== "visible") {
            //         await saveData();
            //         localStorage.setItem('code.editor', textarea.value.trim());
            //     }
            // });
            // window.addEventListener("beforeunload", async evt => {
            //     await saveData();
            //     localStorage.setItem('code.editor', textarea.value.trim());
            // });
            document.getElementById('format').addEventListener('click', evt => {
                formatCode();
            })
            document.getElementById('save').addEventListener('click', async evt => {
                await saveData();
                localStorage.setItem('code.editor', textarea.value.trim());
            })
            document.getElementById('variables').addEventListener('click', evt => {
                let selectionStart = textarea.selectionStart;
                let selectionEnd = textarea.selectionEnd;
                let s = `let v = 0;`;
                textarea.setRangeText(s, selectionStart, selectionEnd)
            })
            document.getElementById('javascript').addEventListener('click', evt => {


                let selectionStart = textarea.selectionStart;
                let selectionEnd = textarea.selectionEnd;
                let s = `if(x === undefined){
}
else if(x !== undefined){
}
else{
}`;
                textarea.setRangeText(s, selectionStart, selectionEnd)
            })
            document.getElementById('preview').addEventListener('click', async evt => {
                await preview();
            })
            document.getElementById('comment').addEventListener('click', evt => {
                comment(textarea);
            })
            document.getElementById('function').addEventListener('click', evt => {
                functions(textarea);
            })
            document.getElementById('translate').addEventListener('click', evt => {
                translate(baseUri, textarea);
            })
            document.getElementById('find_replace').addEventListener('click', evt => {
                findReplace(textarea);
            })
            document.getElementById('text_snippet').addEventListener('click', evt => {
                showSnippetsDialog();
            })
            document.addEventListener('keydown', async evt => {
                if (evt.ctrlKey) {
                    if (evt.key === 's') {
                        evt.preventDefault();
                        await saveData();
                    }
                } else {
                    if (evt.key === 'F1') {
                        evt.preventDefault();
                        formatCode();
                    } else if (evt.key === 'F3') {
                        evt.preventDefault();
                        await preview();
                    } else if (evt.key === 'F4') {
                        evt.preventDefault();
                        window.location.href = `?id=${parseInt(id) + 1}`
                    } else if (evt.key === 'F2') {
                        evt.preventDefault();
                        await glslTemplate();
                    }
                }

            })



        }

        async function preview() {
            try {
                await saveData();
                localStorage.setItem('code.editor', textarea.value.trim());
            } catch (error) {

            }
            window.open(`/viewer?id=${id}`, '_blank');
        }
        cacheCode();
        initialize();

    </script>
</body>

</html>