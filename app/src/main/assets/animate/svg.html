<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG 编辑器</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-html.min.js"></script>

    <link rel="stylesheet" href="index.css">
    <script src="custom-toast.js"></script>
    <script src="shared.js"></script>
</head>

<body>
    <div class="wrapper" style="padding-top: 49px;">
        <textarea id="textarea"></textarea>
    </div>
    <div class="bar-renderer" style="top: 0;">

        <div class="bar-item-tab" id="format">
            <span class="material-symbols-outlined">
                code
            </span>
            <div class="pivot-bar-item-title">格式化</div>
        </div>
        <div class="bar-item-tab" id="calculate">
            <span class="material-symbols-outlined">
                calculate
            </span>
            <div class="pivot-bar-item-title">计算</div>
        </div>

        <div class="bar-item-tab" id="square_foot">
            <span class="material-symbols-outlined">
                square_foot
            </span>
            <div class="pivot-bar-item-title">长度</div>
        </div>

        <div class="bar-item-tab" id="pattern">
            <span class="material-symbols-outlined">
                pattern
            </span>
            <div class="pivot-bar-item-title">模式</div>
        </div>
        <div class="bar-item-tab" id="comment">
            <span class="material-symbols-outlined">
                comment
            </span>
            <div class="pivot-bar-item-title">注释</div>
        </div>
        <div class="bar-item-tab" id="degree">
            <span class="material-symbols-outlined">
                square_foot
            </span>
            <div class="pivot-bar-item-title">角度</div>
        </div>
    </div>
    <div class="bar-renderer">
        <div class="bar-item-tab" id="save">
            <span class="material-symbols-outlined">
                save
            </span>
            <div class="pivot-bar-item-title">保存</div>
        </div>



        <div class="bar-item-tab" id="preview">
            <span class="material-symbols-outlined">
                preview
            </span>
            <div class="pivot-bar-item-title">预览</div>
        </div>
        <div class="bar-item-tab" id="text_snippet">
            <span class="material-symbols-outlined">
                text_snippet
            </span>
            <div class="pivot-bar-item-title">代码段</div>
        </div>
        <div class="bar-item-tab" id="edit_note">
            <span class="material-symbols-outlined">
                edit_note
            </span>
            <div class="pivot-bar-item-title">注释</div>
        </div>
        <div class="bar-item-tab" id="help">
            <span class="material-symbols-outlined">
                help
            </span>
            <div class="pivot-bar-item-title">帮助</div>
        </div>


    </div>
    <div id="dialog" style="position: fixed;left:0;right: 0;bottom: 0;top: 0;
    background: rgba(0, 0, 0, .35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    ">
        <div style="width: 80vw;max-height: 70vh;font-size: 12px; display: flex;
align-items: center;
justify-content: center;
background-color: #fff;
flex-direction: column;
">
            <div id="dialog-list" style="display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100%;
            padding:0 12px;
            box-sizing: border-box;
            line-height: 24px;
            font-size: 12px;
            ">

            </div>
            <div style="display: flex;
            align-items: center;
            justify-content: center;
            line-height: 32px;
            width: 100%;
            ">
                <div id="import_snippets" style="flex-grow: 1;text-align: center;">导出</div>
                <div id="export_snippets" style="flex-grow: 1;text-align: center;">导入</div>
                <div id="add_snippet" style="flex-grow: 1;text-align: center;">添加</div>
            </div>
        </div>
    </div>

    <script>
        const dialog = document.getElementById('dialog');
        dialog.addEventListener('click', evt => {
            dialog.style.display = 'none';
        })

        const dialogBody = document.getElementById('dialog-list');
        let snippets = [];
        document.getElementById('import_snippets')
            .addEventListener('click', evt => {
                try {
                    snippets = JSON.parse(textarea.value.trim())
                    snippets = [...new Set(snippets)];
                    localStorage.setItem('snippets', JSON.stringify(snippets));
                } catch (e) {

                }
            });
        document.getElementById('export_snippets')
            .addEventListener('click', evt => {
                textarea.value = textarea.value + "\n\n\n" + JSON.stringify(snippets);
            });
        document.getElementById('add_snippet')
            .addEventListener('click', evt => {
                dialog.style.display = 'none';
                let selectionStart = textarea.selectionStart;
                let selectionEnd = textarea.selectionEnd;
                let selectedString = textarea.value.substring(selectionStart, selectionEnd);

                const s = selectedString.trim();
                if (s) {
                    snippets.push(s);
                    snippets = [...new Set(snippets)];
                    localStorage.setItem('snippets', JSON.stringify(snippets));
                }

            })
        function loadSnippets() {
            const s = localStorage.getItem('snippets') || '[]';
            snippets = JSON.parse(s);
            dialogBody.innerHTML = '';
            const array = [];
            snippets.forEach(snippet => {
                array.push(`<div class="dialog-item" style="width: 100%;border:1px solid #ddd;
                display: flex;
            align-items: center;
            justify-content: center;"
            data-snippet="${escapeHtml(snippet)}"
            >
                    <div style="flex-grow: 1;">${escapeHtml(snippet)}</div>
                    <div class="dialog-delete"  style="width: 24px;text-align: center;">X</div>
                </div>`)
            })

            dialogBody.innerHTML = array.join('');
            document.querySelectorAll('.dialog-item')
                .forEach(x => {
                    x.addEventListener('click', evt => {
                        let selectionStart = textarea.selectionStart;
                        let selectionEnd = textarea.selectionEnd;
                        let selectedString = textarea.value.substring(selectionStart, selectionEnd);
                        textarea.value = `${textarea.value.substring(0, selectionStart)}${x.dataset.snippet}${textarea.value.substring(selectionEnd)}`;
                    });
                    x.querySelector('.dialog-delete')
                        .addEventListener('click', evt => {
                            evt.stopPropagation();
                            const array = [];
                            for (let index = 0; index < snippets.length; index++) {
                                const element = snippets[index]; if (element === x.dataset.snippet) { }
                                if (element === x.dataset.snippet) {
                                    continue;
                                }
                                array.push(element);
                            }
                            snippets = [...new Set(array)];
                            localStorage.setItem('snippets', JSON.stringify(snippets));
                            dialog.style.display = 'none';

                        });
                })
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
    <custom-toast id="toast"></custom-toast>
    <script>
        const textarea = document.getElementById("textarea");
        function cacheCode() {
            textarea.value = localStorage.getItem('svg');
            document.addEventListener('visibilitychange', evt => {
                localStorage.setItem('svg', textarea.value.trim());
            });
        }
        function initialize() {
            document.getElementById('format').addEventListener('click', evt => {
                formatCode();
            })
            document.getElementById('save').addEventListener('click', evt => {
                localStorage.setItem('code', textarea.value.trim());
            })
            document.getElementById('calculate').addEventListener('click', evt => {
                calculate();
            })
            document.getElementById('preview').addEventListener('click', evt => {
                window.open("./svgpreview.html", '_blank');
            })
            document.getElementById('text_snippet').addEventListener('click', evt => {
                window.open("./snippets.html", '_blank');
            })
            document.getElementById('help').addEventListener('click', evt => {
                window.open("./svghelper.html", '_blank');
            })
            document.getElementById('edit_note').addEventListener('click', evt => {
                window.open("./text-swipe.html", '_blank');
            })
            document.getElementById('pattern').addEventListener('click', evt => {
                dialog.style.display = 'flex';
                loadSnippets();
            })
            document.getElementById('comment').addEventListener('click', evt => {
                processSelection(s => {
                    return `<!--
Math.sin(30*Math.PI/180)*
/Math.sin(30*Math.PI/180)
360,360,6,200
fill="#2196F3"
fill="none"
fill="freeze"
id=""
begin=".end+1s"

                        -->`
                })
            })
            document.getElementById('degree').addEventListener('click', evt => {
                processSelection(selectedString => {
                    let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', selectedString);
                    svg.appendChild(path);
                    svg.style.position = 'absolute';
                    svg.style.left = '-100%';
                    document.body.appendChild(svg);

                    var len = path.getTotalLength();
                    var firstPoint = path.getPointAtLength(0);
                    var secondPoint = path.getPointAtLength(len);
                    var deg = Math.atan2(firstPoint.y - secondPoint.y, firstPoint.x - secondPoint.x) * (180 / Math.PI);
                    svg.remove();
                    return deg
                })
            })

        }
        function formatCode() {
            const options = { indent_size: 2, space_in_empty_paren: true }
            textarea.value = html_beautify(textarea.value, options);

        }
        document.addEventListener('keydown', evt => {
            if (evt.key === 'F1') {
                evt.preventDefault();
                formatCode();
            }
        })
        cacheCode();
        initialize();

        function calculate() {

            processSelection(s => {
                if (s.indexOf('<path') !== -1 &&
                    s.indexOf('<text') !== -1) {
                    return calculateCenterTextPath(s)
                } else if (/^[0-9]+<path/.test(s)) {
                    return calculateMoveAlongNormalPath(s)
                } else if (/\d+,\d+,\d+,\d+/.test(s)) {
                    return eval(`drawPolygon(${s})`);
                } else {
                    return eval(s);
                }
            })
        }
        document.getElementById('square_foot')
            .addEventListener('click', evt => {
                processSelection(s => {
                    if (s.indexOf('<') !== -1) {

                        return animateShape(s);
                    } else {
                        return animatePath(s);
                    }
                })
            });
        function processSelection(fn) {
            let selectionStart = textarea.selectionStart;
            let selectionEnd = textarea.selectionEnd;
            let selectedString = textarea.value.substring(selectionStart, selectionEnd);
            if (!selectedString) {
                selectedString = getLine(textarea);
                if (textarea.value[selectionStart] !== '\n') {
                    while (selectionStart + 1 < textarea.value.length && textarea.value[selectionStart + 1] !== '\n') {
                        selectionStart++;
                    }
                    selectionStart++;
                }

                selectionEnd = selectionStart
                textarea.value = `${textarea.value.substring(0, selectionStart)}
${fn(selectedString.trim())}${textarea.value.substring(selectionEnd)}`;
                return;
            }
            textarea.value = `${textarea.value.substring(0, selectionStart)}${fn(selectedString.trim())}${textarea.value.substring(selectionEnd)}`;

        }
        function getLine(textarea) {
            let start = textarea.selectionStart;
            let end = textarea.selectionEnd;
            if (textarea.value[start] === '\n' && start - 1 > 0) {
                start--;
            }
            if (textarea.value[end] === '\n' && end - 1 > 0) {
                end--;
            }
            while (start - 1 > -1 && textarea.value[start - 1] !== '\n') {
                start--;
            }
            while (end + 1 < textarea.value.length && textarea.value[end + 1] !== '\n') {
                end++;
            }
            return textarea.value.substring(start, end + 1);
        }
        function animateShape(selectedString) {
            let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.innerHTML = selectedString;
            svg.style.position = 'absolute';
            svg.style.left = '-100%';
            document.body.appendChild(svg);

            var len = svg.children[0].getTotalLength();
            svg.remove();
            return `
${substringBefore(selectedString, '>')} 
fill="none" 
stroke="red" 
stroke-width="4"
stroke-dasharray="${len}"
stroke-dashoffset="${len}" >
<animate id="" 
begin="1s" 
attributeName="stroke-dashoffset" 
values="${len};0" 
dur="1s" 
calcMode="linear" 
fill="freeze"/>
    </${selectedString.match(/(?<=<)[^ ]+/)}>
`;
        }
        function animatePath(selectedString) {
            let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', selectedString);
            svg.appendChild(path);
            svg.style.position = 'absolute';
            svg.style.left = '-100%';
            document.body.appendChild(svg);

            var len = path.getTotalLength();
            svg.remove();
            return `
<path d="${selectedString}" 
fill="none" 
stroke="red" 
stroke-width="4"
stroke-dasharray="${len}"
stroke-dashoffset="${len}" >
<animate id="" 
begin="1s" 
attributeName="stroke-dashoffset" 
values="${len};0" 
dur="1s" 
calcMode="linear" 
fill="freeze"/>
    </path>
`;
        }
        function drawPolygon(x, y, n, radius, options = {}) {
            const array = [];
            array.push(
                [x + radius * Math.cos(options.rotation || 0),
                y + radius * Math.sin(options.rotation || 0)]);
            for (let i = 1; i <= n; i += 1) {
                const angle = (i * (2 * Math.PI / n)) + (options.rotation || 0);
                array.push(
                    [
                        x + radius * Math.cos(angle),
                        y + radius * Math.sin(angle)
                    ])
            }
            const d = `M${array.map(x => `${x[0]} ${x[1]}`).join('L')}`;
            return `<path stroke="#FF5722" fill="none" stroke-width="4"  d="${d}">
    </path>`
        }
        function getTotalLength(d) {
            let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', d);
            svg.appendChild(path);
            svg.style.position = 'absolute';
            svg.style.left = '-100%';
            document.body.appendChild(svg);

            var len = path.getTotalLength();
            svg.remove();
            return len;
        }
        function getBBox(s, isLen) {
            let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.innerHTML = s;
            svg.style.position = 'absolute';
            svg.style.left = '-100%';
            document.body.appendChild(svg);

            var len = isLen ? svg.children[0].getTotalLength() : svg.children[0].getBBox();
            svg.remove()
            return len;
        }
        function getCenterPath(s, offset) {
            let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.innerHTML = s;
            svg.style.position = 'absolute';
            svg.style.left = '-100%';
            document.body.appendChild(svg);

            var len = svg.children[0].getTotalLength();
            let first = svg.children[0].getPointAtLength(len / 2 - offset)
            let second = svg.children[0].getPointAtLength(len / 2 + offset)

            svg.remove()
            return `M${first.x} ${first.y}L${second.x} ${second.y}`;
        }
        function getNormalPath(s, offset) {
            let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.innerHTML = s;
            svg.style.position = 'absolute';
            svg.style.left = '-100%';
            document.body.appendChild(svg);

            var len = svg.children[0].getTotalLength();
            let firstPoint = svg.children[0].getPointAtLength(0)
            let secondPoint = svg.children[0].getPointAtLength(len)
            var deg = Math.atan2(firstPoint.y - secondPoint.y, firstPoint.x - secondPoint.x) * (180 / Math.PI);
            deg = 180 - deg;
            var offsetX = Math.sin(deg / Math.PI * 180) * offset;
            var offsetY = Math.cos(deg / Math.PI * 180) * offset;

            svg.remove()
            return `M${firstPoint.x + offsetX} ${firstPoint.y + offsetY}L${secondPoint.x + offsetX} ${secondPoint.y + offsetY}`;
        }

        function calculateCenterTextPath(s) {
            let path = substringBefore(s, "<text");
            let text = "<text" + substringAfter(s, "<text");
            let box = getBBox(text, false);
            let v = getCenterPath(path, box.width / 2)
            return s.replace(/(?<=d=")[^"]+(?=")/, v);
        }
        function calculateMoveAlongNormalPath(s) {
            let offset = substringBefore(s, "<path").trim();
            let path = "<path" + substringAfter(s, "<path");
            let v = getNormalPath(path, parseInt(offset))
            return s.replace(/(?<=d=")[^"]+(?=")/, v);
        }
    </script>
</body>

</html>